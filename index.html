<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      overflow: hidden;
      background: #000; /* Black background for immersive effect */
    }

    /* Canvas fills the screen and is displayed as block */
    canvas {
      display: block;
    }

    /* Transparent overlay to capture tap events */
    #tap-overlay {
      position: absolute;
      inset: 0;
      background: transparent;
      z-index: 10;
    }

    /* Toast message style shown at bottom center */
    #toast-msg {
      position: absolute;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      color: #000;
      padding: 10px 20px;
      border-radius: 25px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 16px;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.5s ease;
      white-space: nowrap;
      text-align: center;
    }

    /* Show toast by setting opacity to 1 */
    #toast-msg.show {
      opacity: 1;
    }
  </style>
</head>

<body>
  
  <div id="tap-overlay"></div> <!-- Transparent overlay to detect user taps to enable motion -->
  <div id="toast-msg">Tap anywhere to enable motion</div> <!-- Toast message prompting user to tap for motion permission -->
  
  <canvas id="canvas3d"></canvas> <!-- Canvas where 3D scene will be rendered -->

  <script type="module">
    
    import { Application } from './runtime.js'; // Import the Application class from runtime.js to initialize 3D app

    const canvas = document.getElementById('canvas3d'); // Get reference to the canvas element
    const app = new Application(canvas, { wasmPath: '/' }); // Create a new Application instance with wasm path configured
    app.load('./scene.splinecode'); // Load the 3D scene file

    // Variables to store rotation values for the 3D subject
    let rotationX = 0;
    let rotationY = 0;

    // Get references to tap overlay and toast message elements
    const tapOverlay = document.getElementById('tap-overlay');
    const toastMsg = document.getElementById('toast-msg');

    // Show the toast message shortly after page load to prompt user interaction
    setTimeout(() => {
      toastMsg.classList.add('show');
    }, 500); // slight delay after load

    // Function to start listening to device motion after permission granted
    async function startMotion() {
      // On iOS devices, permission is required to access motion sensors
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        const response = await DeviceMotionEvent.requestPermission();
        if (response !== 'granted') {
          // Alert user if permission is denied and reload page
          alert(
            "Apple Motion Access Was Denied. \n\n" +
            "Please close reopen Safari to allow Motion and Orientation access."
          );
          location.reload();
          return;
        }
      }

      // Listen for device orientation events to update rotation
      window.addEventListener('deviceorientation', (event) => {
        // Ignore events without beta or gamma values
        if (event.beta == null || event.gamma == null) return;

        // Define baseline orientation values (neutral position)
        const BASE_BETA = 45;  // phone tilted toward user
        const BASE_GAMMA = 0;  // centered left-right

        // Calculate relative rotation from baseline
        let relX = event.beta - BASE_BETA;
        let relY = event.gamma - BASE_GAMMA;

        // Clamp rotation values to a max range to avoid extreme tilts
        relX = Math.max(-30, Math.min(30, relX));
        relY = Math.max(-30, Math.min(30, relY));

        // Smoothly ease rotation values for smoother animation
        rotationX += (relX - rotationX) * 0.08;
        rotationY += (relY - rotationY) * 0.08;

        // Find the 3D object named "Subject" or whatever you keep in the scene, replace if different
        const target = app.findObjectByName("Subject");
        if (target) {
          // Apply rotation to the subject in radians
          target.rotation.x = rotationX * (Math.PI / 180);
          target.rotation.y = rotationY * (Math.PI / 180);
        }
      });

    }

    // Handle tap on overlay to request motion access and start rotation updates
    tapOverlay.addEventListener('click', async () => {
      await startMotion();
      // Hide the tap overlay after permission granted
      tapOverlay.style.display = 'none';
      // Fade out the toast message
      toastMsg.classList.remove('show');
      // After fade out transition, hide the toast completely
      setTimeout(() => {
        toastMsg.style.display = 'none';
      }, 500); // matches CSS transition duration
    });
  </script>
</body>

</html>